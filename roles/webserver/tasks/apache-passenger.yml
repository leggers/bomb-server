- name: Ensure apache packages are installed
  apt: pkg={{item}}
  with_items:
    - libcurl4-openssl-dev
    - libssl-dev
    - zlib1g-dev
    - apache2-mpm-prefork
    - apache2-prefork-dev
    - libapr1-dev
    - libaprutil1-dev

# inspiration: http://www.modrails.com/documentation/Users%20guide%20Apache.html#install_on_debian_ubuntu
- name: install passenger gem
  shell: gem install passenger --version {{passenger_version}} creates=~/.rvm/rubies/ruby-{{ruby}}/bin/passenger executable=/bin/bash
  remote_user: deploy
  sudo: no

# - name: get passenger version
#   shell: passenger -v
#   register: passenger_shell_output
#   remote_user: deploy
#   sudo: no

# - name: set passenger version
#   set_fact:
#     passenger_version: "{{passenger_shell_output.stdout_lines[0] | regex_replace('\D* ', '') | regex_replace(',', '')}}"

# - name: write ansible version to a file
#   lineinfile: create=yes state=present line={{passenger_version}} dest=~/passenger_version.txt
#   remote_user: deploy
#   sudo: no

- name: install passenger mod
  command: rvm {{ruby}} do passenger-install-apache2-module --auto creates=~/.rvm/gems/ruby-{{ruby}}@global/gems/passenger-{{passenger_version}}/buildout/apache2/mod_passenger.so
  remote_user: deploy
  sudo: no

- name: configure apache and passenger
  template: src=passenger-{{item}}-config.j2 dest=/etc/apache2/mods-available/passenger.{{item}} owner=deploy group=deploy
  with_items:
    - load
    - conf

- name: enable passenger
  file: src=/etc/apache2/mods-available/passenger.{{item}} dest=/etc/apache2/mods-enabled/passenger.{{item}}
  with_items:
    - load
    - conf

- name: Ensure apache app config files are present
  template: src=apache-config.j2 dest=/etc/apache2/sites-available/{{item}}.conf owner=deploy group=deploy
  with_items: app_names
  notify:
    - restart apache

- name: Ensure apache config files are symlinked
  file: src=/etc/apache2/sites-available/{{item}}.conf dest=/etc/apache2/sites-enabled/{{item}}.conf state=link
  with_items: app_names
  notify:
    - reload apache

- name: Ensure default apache site is disabled
  file: dest=/etc/apache2/sites-enabled/000-default.conf state=absent